<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Paper Trader (Offline, No API)</title>
<!-- ‡∏Å‡∏£‡∏≤‡∏ü Lightweight Charts (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏µ‡∏¢‡πå) -->
<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
<style>
:root{
  --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee; --green:#10b981; --red:#ef4444; --card:#0b1220; --border:#1f2937;
}
*{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#0b1020,#0b1220 50%,#0a0f1f);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai","Noto Sans",Arial}
header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);background:#0c1426;position:sticky;top:0;z-index:5}
header .title{font-weight:700;letter-spacing:.2px}
.badge{font-size:12px;color:#0ea5e9;background:#082031;border:1px solid #113b57;padding:3px 8px;border-radius:999px}
.container{display:grid;grid-template-columns:320px 1fr 380px;gap:12px;padding:12px}
@media (max-width:1100px){.container{grid-template-columns:1fr}}
section.card{background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.card h3{margin:0;padding:10px 12px;border-bottom:1px solid var(--border);background:#0e182c;font-size:13px;color:var(--muted);letter-spacing:.4px;text-transform:uppercase}
.card .body{padding:12px}
input,select,button{font:inherit}
input[type="text"],input[type="number"],input[type="file"],select{
  width:100%;background:#0a1324;color:var(--text);border:1px solid #213149;border-radius:8px;padding:8px 10px;outline:none
}
input:focus,select:focus{border-color:#2eaedb;box-shadow:0 0 0 2px #1b3a53}
button{cursor:pointer;border:1px solid #1e293b;background:#10233b;color:var(--text);padding:8px 10px;border-radius:8px}
button.primary{background:linear-gradient(180deg,#0fb3d1,#0891b2);border-color:#0ea5b1}
button.buy{background:linear-gradient(180deg,#16a34a,#0f8c3f);border-color:#16a34a}
button.sell{background:linear-gradient(180deg,#ef4444,#b91c1c);border-color:#ef4444}
.row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.muted{color:var(--muted)}
.pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#0a1324;color:var(--muted);font-size:12px}
.watchlist{display:flex;flex-wrap:wrap;gap:8px}
.chip{padding:6px 10px;background:#0b1220;border:1px solid #1e293b;border-radius:999px;cursor:pointer}
.chip.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(34,211,238,.25)}
#chart{height:420px}
.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
.stat{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px}
.stat .k{font-size:12px;color:var(--muted)} .stat .v{font-weight:700;font-size:18px}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #1b2a3f;padding:8px;text-align:right}
th{text-align:right;color:var(--muted);font-weight:600;font-size:12px}
th:first-child,td:first-child{text-align:left}
.pos{color:var(--green)} .neg{color:var(--red)}
.hint{font-size:12px;color:#93c5fd;background:#0b2142;border:1px solid #193b6e;padding:8px;border-radius:8px;margin-top:8px}
h4{margin:12px 0 6px}
footer{padding:12px;color:#8da2c0;text-align:center}
dialog{max-width:560px;width:92%;border:none;border-radius:12px;background:#0c162b;color:var(--text)}
</style>
</head>
<body>
<header>
  <div class="title">üìà Paper Trader (Offline ‚Ä¢ No API)</div>
  <div class="flex">
    <span id="modeBadge" class="badge">Simulator</span>
    <button id="settingsBtn">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
    <button id="resetBtn" title="‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏û‡∏≠‡∏£‡πå‡∏ï</button>
  </div>
</header>

<div class="container">
  <!-- ‡∏ã‡πâ‡∏≤‡∏¢: ‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå & ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå -->
  <section class="card">
    <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏∏‡πâ‡∏ô & ‡∏ß‡∏≤‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h3>
    <div class="body">
      <div class="row">
        <div>
          <label>‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå (‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô AAPL, PTTEP)</label>
          <input id="symbolInput" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‚Ä¶" />
        </div>
        <div style="align-self:end"><button id="setSymbolBtn" class="primary" style="width:100%">‡∏ï‡∏±‡πâ‡∏á</button></div>
      </div>
      <div class="watchlist" id="watchlist"></div>
      <div class="hint">‡∏ó‡∏£‡∏¥‡∏Ñ: ‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡∏•‡∏Ñ‡∏•‡∏¥‡∏Å‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</div>

      <hr style="border-color:#1e293b;margin:12px 0">
      <div class="row">
        <div><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏´‡∏∏‡πâ‡∏ô)</label><input id="qtyInput" type="number" min="1" step="1" value="1"></div>
        <div><label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</label><div id="pxNow" class="pill">‚Äî</div></div>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="btnBuy" class="buy">‡∏ã‡∏∑‡πâ‡∏≠ (Market)</button>
        <button id="btnSell" class="sell">‡∏Ç‡∏≤‡∏¢ (Market)</button>
      </div>

      <h4>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á</h4>
      <div class="row">
        <div><label>Limit Price</label><input id="limitPx" type="number" step="0.01" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á Limit"></div>
        <div><label>Stop Price</label><input id="stopPx" type="number" step="0.01" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á Stop"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnPlaceLimitBuy">‡∏ï‡∏±‡πâ‡∏á BUY Limit</button>
        <button id="btnPlaceLimitSell">‡∏ï‡∏±‡πâ‡∏á SELL Limit</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnPlaceStopBuy">‡∏ï‡∏±‡πâ‡∏á BUY Stop</button>
        <button id="btnPlaceStopSell">‡∏ï‡∏±‡πâ‡∏á SELL Stop</button>
      </div>
      <div class="hint">Limit = ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏î‡∏µ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á ‚Ä¢ Stop = ‡∏ó‡∏£‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ï‡∏•‡∏≤‡∏î</div>
    </div>
  </section>

  <!-- ‡∏Å‡∏•‡∏≤‡∏á: ‡∏Å‡∏£‡∏≤‡∏ü -->
  <section class="card" style="min-width:280px">
    <h3>‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏Ñ‡∏≤ (Offline Simulator / CSV Replay)</h3>
    <div class="body">
      <div id="chart"></div>
      <div class="flex" style="margin-top:8px">
        <label>‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤</label>
        <select id="resolution">
          <option value="1">1m</option><option value="5">5m</option>
          <option value="15" selected>15m</option><option value="60">1h</option><option value="D">1D</option>
        </select>
        <button id="reloadBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏´‡∏°‡πà</button>
        <span class="pill" id="engineLabel">Engine: Simulator</span>
      </div>

      <h4>‡πÇ‡∏´‡∏°‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
      <div class="flex">
        <select id="dataMode">
          <option value="sim" selected>Simulator (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á)</option>
          <option value="csv">CSV Replay (‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå)</option>
        </select>
        <div id="simPanel" class="flex">
          <span class="pill">Œº (drift)</span><input id="mu" type="number" step="0.01" value="0.12" style="width:90px">
          <span class="pill">œÉ (vol)</span><input id="sigma" type="number" step="0.01" value="0.30" style="width:90px">
          <span class="pill">Tick (ms)</span><input id="tickMs" type="number" step="50" value="1000" style="width:90px">
          <span class="pill">Seed</span><input id="seed" type="number" step="1" value="1" style="width:90px">
        </div>
        <div id="csvPanel" class="flex" style="display:none">
          <input id="csvFile" type="file" accept=".csv,text/csv" />
          <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß</label>
          <select id="replaySpeed">
            <option value="1">1x</option><option value="2">2x</option><option value="5" selected>5x</option><option value="10">10x</option><option value="30">30x</option>
          </select>
        </div>
      </div>

      <div class="hint">
        CSV ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: ‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ <code>time,open,high,low,close</code> (‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô UNIX seconds ‡∏´‡∏£‡∏∑‡∏≠ ISO8601) ‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÅ‡∏ñ‡∏ß‡∏ï‡πà‡∏≠‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô
      </div>
    </div>
  </section>

  <!-- ‡∏Ç‡∏ß‡∏≤: ‡∏û‡∏≠‡∏£‡πå‡∏ï/‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå -->
  <section class="card">
    <h3>‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
    <div class="body">
      <div class="stats">
        <div class="stat"><div class="k">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</div><div id="cash" class="v">‚Äî</div></div>
        <div class="stat"><div class="k">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏û‡∏≠‡∏£‡πå‡∏ï</div><div id="equity" class="v">‚Äî</div></div>
        <div class="stat"><div class="k">‡∏Å‡∏≥‡πÑ‡∏£‚Äì‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</div><div id="totalPnL" class="v">‚Äî</div></div>
      </div>

      <h4>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏¥‡∏î</h4>
      <table id="posTable">
        <thead><tr><th>‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>PnL</th></tr></thead>
        <tbody></tbody>
      </table>

      <h4>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏≤‡∏á</h4>
      <table id="ordTable">
        <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå</th><th>‡∏î‡πâ‡∏≤‡∏ô</th><th>‡∏ä‡∏ô‡∏¥‡∏î</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</th></tr></thead>
        <tbody></tbody>
      </table>

      <h4>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î</h4>
      <table id="histTable">
        <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå</th><th>‡∏î‡πâ‡∏≤‡∏ô</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤</th><th>Realized</th></tr></thead>
        <tbody></tbody>
      </table>

      <div class="hint">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ (localStorage)</div>
    </div>
  </section>
</div>

<!-- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ -->
<dialog id="settingsDlg">
  <div style="padding:14px 16px;border-bottom:1px solid #1e293b;display:flex;justify-content:space-between;align-items:center">
    <div style="font-weight:700">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div><button id="closeSettings">‡∏õ‡∏¥‡∏î</button>
  </div>
  <div style="padding:16px;display:grid;gap:12px">
    <div class="row">
      <div>
        <label>‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô (USD)</label>
        <input id="startingCash" type="number" min="0" step="100" value="10000">
      </div>
      <div style="align-self:end"><button id="saveSettings" class="primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
    </div>
    <div class="hint">‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏ó‡∏£‡∏î ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
  </div>
</dialog>

<footer>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô</footer>

<script>
(() => {
  // ===== Utils / Storage =====
  const $ = s => document.querySelector(s);
  const fmtUSD = n => (n??0).toLocaleString('th-TH',{style:'currency',currency:'USD',maximumFractionDigits:2});
  const fmtNum = n => (n??0).toLocaleString('th-TH', {maximumFractionDigits:2});
  const LSK = 'paper_trader_offline_v1';

  const defaultState = {
    startingCash: 10000, cash: 10000,
    positions: {}, // sym -> {qty, avg, lots:[{qty,price}]}
    history: [],   // fills
    orders: [],    // open orders
    pinned: 'AAPL',
    symbol: 'AAPL',
    symbolPrice: {}, // last price per symbol
    simSeeds: {},    // sym -> seed
  };
  let state = {...defaultState, ...(JSON.parse(localStorage.getItem(LSK)||'{}'))};
  function save(){ localStorage.setItem(LSK, JSON.stringify(state)); }
  function resetAll(){
    if(!confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) return;
    const keep = { pinned: state.pinned };
    state = {...defaultState, ...keep};
    state.cash = state.startingCash;
    save(); location.reload();
  }

  // ===== RNG (seeded) & Math =====
  function hashStr(s){ let h=2166136261; for(let i=0;i<s.length;i++){h^=s.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }
  function xorshift32(a){ return function(){ a^=a<<13; a^=a>>>17; a^=a<<5; return (a>>>0)/0xFFFFFFFF; }; }
  function gaussian(rng){
    // Box-Muller
    let u=0,v=0; while(u===0)u=rng(); while(v===0)v=rng();
    return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
  }

  // ===== Chart =====
  const chart = LightweightCharts.createChart($('#chart'), {
    layout:{ background:{ type:'solid', color:'#0b1220' }, textColor:'#cbd5e1' },
    grid:{ vertLines:{ color:'#12233e' }, horzLines:{ color:'#12233e' } },
    rightPriceScale:{ borderVisible:false },
    timeScale:{ borderVisible:false, timeVisible:true, secondsVisible:false }
  });
  const candleSeries = chart.addCandlestickSeries();
  const priceLineSeries = chart.addLineSeries({ lineWidth:1 });

  const RES_SEC = { '1':60,'5':300,'15':900,'60':3600,'D':86400 };

  // ===== Engine (Simulator/CSV) =====
  let engine = {
    mode: 'sim', // 'sim' | 'csv'
    lastPrice: null,
    lastBarStart: 0,
    curBar: null,
    timer: null,
    symbol: 'AAPL',
    resolution: '15',
    // sim params
    mu: 0.12, sigma: 0.30, tickMs: 1000, seed: 1, rng: null,
    // csv params
    csvCandles: [], csvIdx: 0, speed: 5
  };

  function initSimForSymbol(sym){
    const baseSeed = (state.simSeeds[sym] ?? (hashStr(sym) ^ hashStr(String(engine.seed))));
    state.simSeeds[sym] = baseSeed; save();
    engine.rng = xorshift32(baseSeed||1);
    // Initial price deterministic-ish
    const base = 50 + Math.floor(engine.rng()*250); // 50‚Äì300
    engine.lastPrice = state.symbolPrice[sym] || base;
  }

  function startEngine(){
    stopEngine();
    engine.resolution = $('#resolution').value;
    const sec = RES_SEC[engine.resolution] || 900;
    engine.lastBarStart = Math.floor(Date.now()/1000/sec)*sec;
    engine.curBar = { time:engine.lastBarStart, open:engine.lastPrice||100, high:engine.lastPrice||100, low:engine.lastPrice||100, close:engine.lastPrice||100 };
    candleSeries.setData([engine.curBar]);
    priceLineSeries.setData([{time:engine.curBar.time, value:engine.curBar.close}]);

    if(engine.mode==='sim'){
      $('#engineLabel').textContent = 'Engine: Simulator';
      engine.timer = setInterval(simTick, Math.max(100, engine.tickMs|0));
    }else{
      $('#engineLabel').textContent = 'Engine: CSV Replay';
      engine.timer = setInterval(csvTick, Math.max(100, 1000/engine.speed));
    }
  }
  function stopEngine(){ if(engine.timer){ clearInterval(engine.timer); engine.timer=null; } }

  function simTick(){
    const dt = (engine.tickMs|0)/1000; // seconds per tick
    const z = gaussian(engine.rng);
    const mu = Number($('#mu').value)||engine.mu;
    const sigma = Number($('#sigma').value)||engine.sigma;
    const S = engine.lastPrice;
    const Snext = S * Math.exp((mu - 0.5*sigma*sigma)*dt + sigma*Math.sqrt(dt)*z);
    updatePrice(Math.max(0.01, Snext));
  }

  function csvTick(){
    if(engine.csvIdx >= engine.csvCandles.length){ stopEngine(); return; }
    const c = engine.csvCandles[engine.csvIdx++];
    // ‡πÉ‡∏ä‡πâ close ‡πÄ‡∏õ‡πá‡∏ô last price ‡πÅ‡∏•‡∏∞‡∏î‡∏±‡∏ô‡πÅ‡∏ó‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡∏•‡∏∞‡πÅ‡∏ó‡πà‡∏á
    engine.lastBarStart = c.time;
    engine.curBar = { time:c.time, open:c.open, high:c.high, low:c.low, close:c.close };
    candleSeries.update(engine.curBar);
    priceLineSeries.update({time:c.time, value:c.close});
    engine.lastPrice = c.close;
    markLastPrice();
    afterPriceUpdate();
  }

  function updatePrice(p){
    const sec = RES_SEC[engine.resolution] || 900;
    const t = Math.floor(Date.now()/1000);
    const barStart = Math.floor(t/sec)*sec;
    if(barStart !== engine.lastBarStart){
      // push bar
      candleSeries.update(engine.curBar);
      engine.lastBarStart = barStart;
      engine.curBar = { time:barStart, open:p, high:p, low:p, close:p };
    }else{
      engine.curBar.high = Math.max(engine.curBar.high, p);
      engine.curBar.low  = Math.min(engine.curBar.low, p);
      engine.curBar.close= p;
    }
    engine.lastPrice = p;
    candleSeries.update(engine.curBar);
    priceLineSeries.update({time:engine.curBar.time, value:engine.curBar.close});
    markLastPrice();
    afterPriceUpdate();
  }

  function markLastPrice(){
    state.symbolPrice[engine.symbol] = engine.lastPrice;
    $('#pxNow').textContent = fmtNum(engine.lastPrice);
  }

  function afterPriceUpdate(){
    // ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏ô‡∏µ‡πâ
    matchOpenOrders(engine.symbol, engine.lastPrice);
    // ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏û‡∏≠‡∏£‡πå‡∏ï
    renderTables(); recalcPortfolio();
  }

  // ===== Orders / Matching =====
  function placeMarket(side, sym, qty){
    const px = engine.lastPrice;
    if(!px){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤'); return; }
    fillOrder({type:'MKT', side, sym, qty, px});
  }
  function placeLimit(side, sym, qty, limitPx){
    if(!limitPx){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Limit Price'); return; }
    const id = 'L'+Date.now()+Math.random().toString(16).slice(2);
    state.orders.unshift({id, ts:new Date().toISOString(), type:'LMT', side, sym, qty, limitPx:Number(limitPx)});
    save(); renderOrders();
  }
  function placeStop(side, sym, qty, stopPx){
    if(!stopPx){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Stop Price'); return; }
    const id = 'S'+Date.now()+Math.random().toString(16).slice(2);
    state.orders.unshift({id, ts:new Date().toISOString(), type:'STP', side, sym, qty, stopPx:Number(stopPx), armed:false});
    save(); renderOrders();
  }
  function cancelOrder(id){
    state.orders = state.orders.filter(o=>o.id!==id); save(); renderOrders();
  }

  function matchOpenOrders(sym, lastPx){
    const toFill = [];
    state.orders.forEach(o=>{
      if(o.sym!==sym) return;
      if(o.type==='LMT'){
        if(o.side==='BUY' && lastPx<=o.limitPx) toFill.push(o);
        if(o.side==='SELL'&& lastPx>=o.limitPx) toFill.push(o);
      }else if(o.type==='STP'){
        // ‡∏ó‡∏∞‡∏•‡∏∏ Stop ‡∏Å‡πá‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô Market
        if(o.side==='BUY' && lastPx>=o.stopPx) toFill.push(o);
        if(o.side==='SELL'&& lastPx<=o.stopPx) toFill.push(o);
      }
    });
    toFill.forEach(o=>{
      // fill ‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏•‡∏≤‡∏î ‡∏ì ‡∏à‡∏∏‡∏î‡∏ó‡∏£‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå
      fillOrder({type:o.type, side:o.side, sym:o.sym, qty:o.qty, px:lastPx});
      cancelOrder(o.id);
    });
  }

  // ===== Positions / Fills =====
  function getPos(sym){ return state.positions[sym] || {qty:0, avg:0, lots:[]}; }
  function setPos(sym, pos){ state.positions[sym]=pos; if(pos.qty===0) delete state.positions[sym]; }

  function fillOrder({type, side, sym, qty, px}){
    qty = Math.max(1, Math.floor(qty));
    const cost = px*qty;
    if(side==='BUY'){
      if(state.cash < cost){ alert('‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÑ‡∏°‡πà‡∏û‡∏≠'); return; }
      const p = getPos(sym);
      const newQty = p.qty + qty;
      const newAvg = (p.qty*p.avg + cost) / newQty;
      p.qty=newQty; p.avg=newAvg; p.lots.push({qty, price:px});
      setPos(sym,p);
      state.cash -= cost;
      pushHist('BUY', sym, qty, px, 0);
    }else{ // SELL
      const p = getPos(sym);
      if(p.qty < qty){ alert('‡∏°‡∏µ‡∏´‡∏∏‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏Ç‡∏≤‡∏¢'); return; }
      let remaining = qty, realized = 0;
      // FIFO lots
      while(remaining>0 && p.lots.length){
        const lot = p.lots[0];
        const take = Math.min(remaining, lot.qty);
        realized += (px - lot.price)*take;
        lot.qty -= take; remaining -= take;
        if(lot.qty===0) p.lots.shift();
      }
      p.qty -= qty;
      setPos(sym,p);
      state.cash += cost;
      pushHist('SELL', sym, qty, px, realized);
    }
    save(); renderTables(); recalcPortfolio();
  }

  function pushHist(side, sym, qty, px, realized){
    state.history.unshift({
      ts: new Date().toISOString(), side, sym, qty, px, notional: qty*px, realized
    });
  }

  // ===== Portfolio calc =====
  function recalcPortfolio(){
    let mkt = 0;
    Object.entries(state.positions).forEach(([sym,p])=>{
      const px = state.symbolPrice[sym] ?? p.avg;
      mkt += px * p.qty;
    });
    const equity = state.cash + mkt;
    const totalPnL = equity - state.startingCash;
    $('#cash').textContent = fmtUSD(state.cash);
    $('#equity').textContent = fmtUSD(equity);
    const sign = totalPnL>=0?'+':'';
    $('#totalPnL').textContent = sign + fmtUSD(totalPnL);
  }

  // ===== Renderers =====
  const watchDefaults = ['AAPL','MSFT','NVDA','TSLA','AMZN','GOOGL','META','AMD','NFLX','BABA'];
  function renderWatchlist(){
    const el = $('#watchlist'); el.innerHTML='';
    const list = Array.from(new Set([state.pinned, ...watchDefaults])).filter(Boolean);
    list.forEach(sym=>{
      const chip = document.createElement('div');
      chip.className = 'chip' + (sym===state.symbol?' active':'');
      chip.textContent = sym;
      chip.title = '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏±‡∏ö / ‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡∏•‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î';
      chip.onclick = ()=> setSymbol(sym);
      chip.ondblclick = ()=>{ state.pinned=sym; save(); renderWatchlist(); };
      el.appendChild(chip);
    });
  }

  function renderTables(){
    // Positions
    const tb = $('#posTable tbody'); tb.innerHTML='';
    Object.entries(state.positions).forEach(([sym,p])=>{
      const px = state.symbolPrice[sym] ?? p.avg;
      const pnl = (px - p.avg)*p.qty;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${sym}</td><td>${fmtNum(p.qty)}</td><td>${fmtNum(p.avg)}</td><td>${fmtNum(px)}</td><td class="${pnl>=0?'pos':'neg'}">${fmtNum(pnl)}</td>`;
      tb.appendChild(tr);
    });
    renderOrders();
    // History
    const hb = $('#histTable tbody'); hb.innerHTML='';
    state.history.slice(0,200).forEach(h=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${new Date(h.ts).toLocaleString('th-TH')}</td>
        <td>${h.sym}</td>
        <td style="color:${h.side==='BUY'?'#10b981':'#ef4444'}">${h.side}</td>
        <td>${fmtNum(h.qty)}</td>
        <td>${fmtNum(h.px)}</td>
        <td>${fmtUSD(h.notional)}</td>
        <td class="${h.realized>=0?'pos':'neg'}">${fmtNum(h.realized)}</td>`;
      hb.appendChild(tr);
    });
  }

  function renderOrders(){
    const ob = $('#ordTable tbody'); ob.innerHTML='';
    state.orders.forEach(o=>{
      const px = o.type==='LMT' ? o.limitPx : (o.type==='STP'? o.stopPx : '-');
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${new Date(o.ts).toLocaleString('th-TH')}</td>
        <td>${o.sym}</td>
        <td style="color:${o.side==='BUY'?'#10b981':'#ef4444'}">${o.side}</td>
        <td>${o.type}</td>
        <td>${typeof px==='number'?fmtNum(px):'-'}</td>
        <td>${fmtNum(o.qty)}</td>
        <td><button data-id="${o.id}">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></td>`;
      tr.querySelector('button').onclick = ()=> cancelOrder(o.id);
      ob.appendChild(tr);
    });
  }

  // ===== Symbol switching =====
  function setSymbol(sym){
    sym = (sym||'').trim().toUpperCase(); if(!sym) return;
    state.symbol = sym; save();
    document.querySelectorAll('.chip').forEach(c=>c.classList.toggle('active', c.textContent===sym));
    engine.symbol = sym;
    if(engine.mode==='sim'){
      initSimForSymbol(sym);
      startEngine();
    }else{
      // CSV: ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô)
      if(!engine.csvCandles.length){ $('#pxNow').textContent='‚Äî'; candleSeries.setData([]); priceLineSeries.setData([]); }
      else { engine.csvIdx=0; startEngine(); }
    }
    recalcPortfolio(); renderTables(); renderWatchlist();
  }

  // ===== Events =====
  $('#setSymbolBtn').onclick = ()=> setSymbol($('#symbolInput').value||state.symbol);
  $('#btnBuy').onclick  = ()=> { const q=+$('#qtyInput').value||1; placeMarket('BUY', state.symbol, q); };
  $('#btnSell').onclick = ()=> { const q=+$('#qtyInput').value||1; placeMarket('SELL', state.symbol, q); };

  $('#btnPlaceLimitBuy').onclick  = ()=>{ const q=+$('#qtyInput').value||1; placeLimit('BUY', state.symbol, q, +$('#limitPx').value); };
  $('#btnPlaceLimitSell').onclick = ()=>{ const q=+$('#qtyInput').value||1; placeLimit('SELL', state.symbol, q, +$('#limitPx').value); };
  $('#btnPlaceStopBuy').onclick   = ()=>{ const q=+$('#qtyInput').value||1; placeStop('BUY', state.symbol, q, +$('#stopPx').value); };
  $('#btnPlaceStopSell').onclick  = ()=>{ const q=+$('#qtyInput').value||1; placeStop('SELL', state.symbol, q, +$('#stopPx').value); };

  $('#reloadBtn').onclick = ()=> startEngine();
  $('#resolution').onchange = ()=> startEngine();

  $('#dataMode').onchange = ()=>{
    engine.mode = $('#dataMode').value;
    $('#simPanel').style.display = engine.mode==='sim' ? 'flex' : 'none';
    $('#csvPanel').style.display = engine.mode==='csv' ? 'flex' : 'none';
    if(engine.mode==='sim'){ initSimForSymbol(state.symbol); startEngine(); }
    else { stopEngine(); /* ‡∏£‡∏≠‡πÑ‡∏ü‡∏•‡πå CSV */ $('#engineLabel').textContent='Engine: CSV Replay'; }
  };
  $('#mu').onchange = ()=> engine.mu = +$('#mu').value;
  $('#sigma').onchange = ()=> engine.sigma = +$('#sigma').value;
  $('#tickMs').onchange = ()=> engine.tickMs = Math.max(50,(+$('#tickMs').value||1000));
  $('#seed').onchange = ()=> { engine.seed = +$('#seed').value||1; initSimForSymbol(state.symbol); startEngine(); };

  $('#csvFile').onchange = async (e)=>{
    const file = e.target.files?.[0]; if(!file) return;
    const text = await file.text();
    const rows = text.trim().split(/\r?\n/);
    const header = rows.shift().split(',').map(s=>s.trim().toLowerCase());
    const idx = {
      time: header.indexOf('time'),
      open: header.indexOf('open'),
      high: header.indexOf('high'),
      low:  header.indexOf('low'),
      close:header.indexOf('close')
    };
    if(Object.values(idx).some(i=>i<0)){ alert('CSV ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå time,open,high,low,close'); return; }
    const parseTime = v=>{
      if(/^\d{10}$/.test(v)) return +v; // unix sec
      if(/^\d{13}$/.test(v)) return Math.floor(+v/1000); // unix ms
      const t = Date.parse(v); return isNaN(t)? null : Math.floor(t/1000);
    };
    const candles=[];
    for(const line of rows){
      const parts=line.split(',');
      const t=parseTime(parts[idx.time]);
      if(!t) continue;
      const o=+parts[idx.open], h=+parts[idx.high], l=+parts[idx.low], c=+parts[idx.close];
      if([o,h,l,c].some(x=>!isFinite(x))) continue;
      candles.push({time:t, open:o, high:h, low:l, close:c});
    }
    candles.sort((a,b)=>a.time-b.time);
    engine.csvCandles = candles;
    engine.csvIdx = 0;
    engine.lastPrice = candles.length? candles[0].open : null;
    engine.speed = +$('#replaySpeed').value||5;
    startEngine();
  };
  $('#replaySpeed').onchange = ()=>{ engine.speed = +$('#replaySpeed').value||5; if(engine.mode==='csv'){ startEngine(); } };

  // Settings
  $('#settingsBtn').onclick = ()=> $('#settingsDlg').showModal();
  $('#closeSettings').onclick = ()=> $('#settingsDlg').close();
  $('#saveSettings').onclick = ()=>{
    state.startingCash = +$('#startingCash').value||10000;
    if(state.history.length===0){ state.cash = state.startingCash; }
    save(); $('#settingsDlg').close(); recalcPortfolio();
  };
  $('#resetBtn').onclick = resetAll;

  // ===== Boot =====
  (function boot(){
    renderWatchlist();
    $('#startingCash').value = state.startingCash;
    engine.mode = 'sim';
    engine.mu = +$('#mu').value; engine.sigma = +$('#sigma').value; engine.tickMs = +$('#tickMs').value; engine.seed = +$('#seed').value;
    $('#dataMode').value = 'sim';
    $('#engineLabel').textContent = 'Engine: Simulator';
    setSymbol(state.symbol || 'AAPL');
    $('#symbolInput').value = state.symbol;
    recalcPortfolio(); renderTables();
    chart.timeScale().fitContent();
  })();

})();
</script>
</body>
</html>
